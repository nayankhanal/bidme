// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}


// Models

model User {
  id Int @id @default(autoincrement())
  name String
  email String @unique
  phone String? @unique
  password String
  role UserRole @default(CUSTOMER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  items Item[]
  bids Bid[]
  actionWins AuctionResult[] @relation("WinnerRelation")
  watchLists WatchList[]
  transactions Transaction[]
  notifications Notification[]
  bidHistorySnapshots BidHistorySnapshot[]
  autoBids AutoBid[]
}

enum UserRole {
  ADMIN
  CUSTOMER
  MANAGER
  SELLER
}

model Item {
  id Int @id @default(autoincrement())
  userId Int
  title String
  description String?
  startingPrice Decimal @db.Decimal(10,2)
  reservePrice Decimal? @db.Decimal(10,2)
  auctionStart DateTime
  auctionEnd DateTime
  status AuctionStatus @default(DRAFT)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?

  user User @relation(fields: [userId], references: [id])
  images Image[]
  bids Bid[]
  auctionResult AuctionResult?
  watchLists WatchList[]
  bidHistorySnapshots BidHistorySnapshot[]
  autoBids AutoBid[]
}

enum AuctionStatus {
  DRAFT
  ACTIVE
  ENDED
}

model Image {
  id Int @id @default(autoincrement())
  itemId Int
  url String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  item Item @relation(fields: [itemId], references: [id])
}

model Bid {
  id Int @id @default(autoincrement())
  itemId Int
  userId Int
  bidAmount Decimal @db.Decimal(10,2)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  item Item @relation(fields: [itemId], references: [id])
  user User @relation(fields: [userId], references: [id])

  @@index([itemId, createdAt])
  @@index([itemId, bidAmount])
}

model AuctionResult {
  id Int @id @default(autoincrement())
  itemId Int @unique
  winnerId Int
  finalPrice Decimal @db.Decimal(10,2)
  paymentStatus PaymentStatus
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  item Item @relation(fields: [itemId], references: [id])
  winner User @relation("WinnerRelation", fields: [winnerId], references: [id])

  transactions Transaction[]
}

enum PaymentStatus {
  PAID
  UNPAID
  PENDING
}


model WatchList {
  id Int @id @default(autoincrement())
  userId Int
  itemId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  item Item @relation(fields: [itemId], references: [id])
  @@unique([userId, itemId])
}

model Transaction {
  id Int @id @default(autoincrement())
  resultId Int
  userId    Int
  amount Decimal @db.Decimal(10,2)
  paymentMethod PaymentMethod
  paymentRef String?
  paymentStatus TransactionStatus
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  result AuctionResult @relation(fields: [resultId], references: [id])
  user User @relation(fields: [userId], references: [id])
}

enum TransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

enum PaymentMethod {
  ESEWA
  KHALTI
  QR
  BANK_TRANSFER
}

model Notification {
  id        Int       @id @default(autoincrement())
  userId    Int
  message   String
  readAt    DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
}

model BidHistorySnapshot {
  id          Int      @id @default(autoincrement())
  itemId      Int
  userId      Int
  bidAmount   Decimal @db.Decimal(10,2)
  highestBidAmount  Decimal @db.Decimal(10,2)
  createdAt   DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  item Item @relation(fields: [itemId], references: [id])
}

model AutoBid {
  id           Int      @id @default(autoincrement())
  userId       Int
  itemId       Int
  maxBidAmount Decimal @db.Decimal(10,2)
  createdAt    DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id])
  item Item @relation(fields: [itemId], references: [id])

  @@unique([userId, itemId]) // user can set auto-bid only once per item
}


model EmailOrPhoneVerification {
  id Int @id @default(autoincrement())
  emailOrPhone String @unique
  otp String
  data Json?
  expiresAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

